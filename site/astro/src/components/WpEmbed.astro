---
interface Props {
  url: string;
  title?: string;
}

const { url, title } = Astro.props;
const domain = new URL(url).hostname;

let ogImage = null;
let pageTitle = title;
let pageDescription = null;

try {
  // Fetch the page content
  const response = await fetch(url, {
    headers: {
      'User-Agent': 'Mozilla/5.0 (compatible; AephiaBot/1.0; +https://aephia.com)'
    }
  });
  
  if (response.ok) {
    const html = await response.text();
    
    // Extract OG Image
    const imageMatch = html.match(/<meta\s+(?:property|name)=["'](?:og:image|twitter:image)["']\s+content=["']([^"']+)["']/i);
    if (imageMatch) {
      ogImage = imageMatch[1];
    }
    
    // Extract OG Title if not provided
    if (!pageTitle) {
      const titleMatch = html.match(/<meta\s+(?:property|name)=["'](?:og:title|twitter:title)["']\s+content=["']([^"']+)["']/i) || html.match(/<title>([^<]+)<\/title>/i);
      if (titleMatch) {
        pageTitle = titleMatch[1];
      }
    }

    // Extract Description (optional, for potentially better display)
    const descMatch = html.match(/<meta\s+(?:property|name)=["'](?:og:description|twitter:description|description)["']\s+content=["']([^"']+)["']/i);
    if (descMatch) {
      pageDescription = descMatch[1];
    }
  }
} catch (error) {
  console.error(`Error fetching embed preview for ${url}:`, error);
}

// Fallback title
pageTitle = pageTitle || url;
---

<div class="wp-embed-card">
  <a href={url} class="wp-embed-link" target="_blank" rel="noopener noreferrer">
    {ogImage && (
      <div class="wp-embed-image">
        <img src={ogImage} alt={pageTitle} loading="lazy" />
      </div>
    )}
    <div class="wp-embed-content">
      <span class="wp-embed-title">{pageTitle}</span>
      {pageDescription && <span class="wp-embed-desc">{pageDescription}</span>}
      <span class="wp-embed-meta">{domain}</span>
    </div>
  </a>
</div>

<style>
  .wp-embed-card {
    border: 1px solid #333;
    border-radius: 8px;
    margin: 2rem 0;
    background: #0f1219;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  }

  .wp-embed-card:hover {
    border-color: var(--color-primary, #00d4ff);
    transform: translateY(-4px);
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
  }

  .wp-embed-link {
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    height: 100%;
  }

  .wp-embed-image {
    width: 100%;
    height: 200px;
    background: #000;
    overflow: hidden;
    border-bottom: 1px solid #222;
  }

  .wp-embed-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .wp-embed-card:hover .wp-embed-image img {
    transform: scale(1.05);
  }

  .wp-embed-content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .wp-embed-title {
    font-weight: bold;
    font-size: 1.1rem;
    line-height: 1.3;
    color: #fff;
    margin-bottom: 0.25rem;
  }

  .wp-embed-desc {
    font-size: 0.9rem;
    color: #aaa;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.5;
  }

  .wp-embed-meta {
    font-size: 0.75rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: auto;
    padding-top: 0.5rem;
  }
</style>
