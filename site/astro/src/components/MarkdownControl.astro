---
interface Props {
  markdown: string;
}

const { markdown } = Astro.props;
---

<div class="markdown-control-wrapper">
  <div class="split-button">
    <!-- Main Copy Button -->
    <button id="main-copy-btn" class="btn btn-left" aria-label="Copy Markdown">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 18 18" class="icon">
        <g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor">
          <path d="m10.75,6.25v-2c0-.8284-.6716-1.5-1.5-1.5h-1"></path>
          <path d="m4.25,2.75h-1c-.8284,0-1.5.6716-1.5,1.5v7.5c0,.8284.6716,1.5,1.5,1.5h3.75"></path>
          <rect x="4.5" y="1.75" width="3.5" height="2" rx=".5" ry=".5" fill="currentColor" fill-opacity="0.2"></rect>
          <rect x="7.25" y="6.25" width="9" height="10" rx="1.5" ry="1.5"></rect>
          <line x1="10.25" y1="9.75" x2="13.25" y2="9.75"></line>
          <line x1="10.25" y1="12.75" x2="13.25" y2="12.75"></line>
        </g>
      </svg>
      <span>Copy</span>
    </button>
    
    <!-- Dropdown Trigger -->
    <button id="dropdown-trigger" class="btn btn-right" aria-label="More options" aria-expanded="false">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
  </div>

  <!-- Dropdown Menu -->
  <div id="dropdown-menu" class="dropdown-menu" hidden>
    <button id="menu-copy-btn" class="menu-item">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 18 18" class="icon">
        <g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor">
          <path d="m10.75,6.25v-2c0-.8284-.6716-1.5-1.5-1.5h-1"></path>
          <path d="m4.25,2.75h-1c-.8284,0-1.5.6716-1.5,1.5v7.5c0,.8284.6716,1.5,1.5,1.5h3.75"></path>
          <rect x="4.5" y="1.75" width="3.5" height="2" rx=".5" ry=".5" fill="currentColor" fill-opacity="0.2"></rect>
          <rect x="7.25" y="6.25" width="9" height="10" rx="1.5" ry="1.5"></rect>
          <line x1="10.25" y1="9.75" x2="13.25" y2="9.75"></line>
          <line x1="10.25" y1="12.75" x2="13.25" y2="12.75"></line>
        </g>
      </svg>
      <div class="menu-item-content">
        <span class="menu-item-title">Copy page</span>
        <span class="menu-item-desc">Copy page as Markdown for LLMs</span>
      </div>
    </button>
    <button id="menu-view-btn" class="menu-item">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 18 18" class="icon">
        <g fill="currentColor">
          <path d="M15.25,3H2.75c-1.517,0-2.75,1.233-2.75,2.75v6.5c0,1.517,1.233,2.75,2.75,2.75H15.25c1.517,0,2.75-1.233,2.75-2.75V5.75c0-1.517-1.233-2.75-2.75-2.75Zm-5.75,8.25c0,.414-.336,.75-.75,.75s-.75-.336-.75-.75v-2.801l-1.155,1.507c-.283,.37-.907,.37-1.19,0l-1.155-1.507v2.801c0,.414-.336,.75-.75,.75s-.75-.336-.75-.75V6.75c0-.414,.336-.75,.75-.75h.394c.233,0,.454,.109,.595,.294l1.511,1.973,1.511-1.973c.142-.185,.362-.294,.595-.294h.394c.414,0,.75,.336,.75,.75v4.5Zm6.03-1.22l-1.75,1.75c-.146,.146-.338,.22-.53,.22s-.384-.073-.53-.22l-1.75-1.75c-.293-.293-.293-.768,0-1.061s.768-.293,1.061,0l.47,.47v-2.689c0-.414,.336,.75-.75,.75s.75,.336,.75,.75v2.689l.47-.47c.293-.293,.768-.293,1.061,0s.293,.768,0,1.061Z"></path>
        </g>
      </svg>
      <div class="menu-item-content">
        <span class="menu-item-title">View as Markdown</span>
        <span class="menu-item-desc">View this page as plain text</span>
      </div>
    </button>
    <div class="menu-divider"></div>
    <button id="menu-gpt-btn" class="menu-item">
      <svg fill="currentColor" fill-rule="evenodd" height="16" width="16" style="flex:none;line-height:1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icon">
        <title>OpenAI</title>
        <path d="M9.205 8.658v-2.26c0-.19.072-.333.238-.428l4.543-2.616c.619-.357 1.356-.523 2.117-.523 2.854 0 4.662 2.212 4.662 4.566 0 .167 0 .357-.024.547l-4.71-2.759a.797.797 0 00-.856 0l-5.97 3.473zm10.609 8.8V12.06c0-.333-.143-.57-.429-.737l-5.97-3.473 1.95-1.118a.433.433 0 01.476 0l4.543 2.617c1.309.76 2.189 2.378 2.189 3.948 0 1.808-1.07 3.473-2.76 4.163zM7.802 12.703l-1.95-1.142c-.167-.095-.239-.238-.239-.428V5.899c0-2.545 1.95-4.472 4.591-4.472 1 0 1.927.333 2.712.928L8.23 5.067c-.285.166-.428.404-.428.737v6.898zM12 15.128l-2.795-1.57v-3.33L12 8.658l2.795 1.57v3.33L12 15.128zm1.796 7.23c-1 0-1.927-.332-2.712-.927l4.686-2.712c.285-.166.428-.404.428-.737v-6.898l1.974 1.142c.167.095.238.238.238.428v5.233c0 2.545-1.974 4.472-4.614 4.472zm-5.637-5.303l-4.544-2.617c-1.308-.761-2.188-2.378-2.188-3.948A4.482 4.482 0 014.21 6.327v5.423c0 .333.143.571.428.738l5.947 3.449-1.95 1.118a.432.432 0 01-.476 0zm-.262 3.9c-2.688 0-4.662-2.021-4.662-4.519 0-.19.024-.38.047-.57l4.686 2.71c.286.167.571.167.856 0l5.97-3.448v2.26c0 .19-.07.333-.237.428l-4.543 2.616c-.619.357-1.356.523-2.117.523zm5.899 2.83a5.947 5.947 0 005.827-4.756C22.287 18.339 24 15.84 24 13.296c0-1.665-.713-3.282-1.998-4.448.119-.5.19-.999.19-1.498 0-3.401-2.759-5.947-5.946-5.947-.642 0-1.26.095-1.88.31A5.962 5.962 0 0010.205 0a5.947 5.947 0 00-5.827 4.757C1.713 5.447 0 7.945 0 10.49c0 1.666.713 3.283 1.998 4.448-.119.5-.19 1-.19 1.499 0 3.401 2.759 5.946 5.946 5.946.642 0 1.26-.095 1.88-.309a5.96 5.96 0 004.162 1.713z"></path>
      </svg>
      <div class="menu-item-content">
        <span class="menu-item-title">Open in ChatGPT</span>
        <span class="menu-item-desc">Ask ChatGPT about this page</span>
      </div>
    </button>
    <button id="menu-claude-btn" class="menu-item">
      <svg fill="currentColor" fill-rule="evenodd" height="16" width="16" style="flex:none;line-height:1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icon">
        <title>Claude</title>
        <path d="M4.709 15.955l4.72-2.647.08-.23-.08-.128H9.2l-.79-.048-2.698-.073-2.339-.097-2.266-.122-.571-.121L0 11.784l.055-.352.48-.321.686.06 1.52.103 2.278.158 1.652.097 2.449.255h.389l.055-.157-.134-.098-.103-.097-2.358-1.596-2.552-1.688-1.336-.972-.724-.491-.364-.462-.158-1.008.656-.722.881.06.225.061.893.686 1.908 1.476 2.491 1.833.365.304.145-.103.019-.073-.164-.274-1.355-2.446-1.446-2.49-.644-1.032-.17-.619a2.97 2.97 0 01-.104-.729L6.283.134 6.696 0l.996.134.42.364.62 1.414 1.002 2.229 1.555 3.03.456.898.243.832.091.255h.158V9.01l.128-1.706.237-2.095.23-2.695.08-.76.376-.91.747-.492.584.28.48.685-.067.444-.286 1.851-.559 2.903-.364 1.942h.212l.243-.242.985-1.306 1.652-2.064.73-.82.85-.904.547-.431h1.033l.76 1.129-.34 1.166-1.064 1.347-.881 1.142-1.264 1.7-.79 1.36.073.11.188-.02 2.856-.606 1.543-.28 1.841-.315.833.388.091.395-.328.807-1.969.486-2.309.462-3.439.813-.042.03.049.061 1.549.146.662.036h1.622l3.02.225.79.522.474.638-.079.485-1.215.62-1.64-.389-3.829-.91-1.312-.329h-.182v.11l1.093 1.068 2.006 1.81 2.509 2.33.127.578-.322.455-.34-.049-2.205-1.657-.851-.747-1.926-1.62h-.128v.17l.444.649 2.345 3.521.122 1.08-.17.353-.608.213-.668-.122-1.374-1.925-1.415-2.167-1.143-1.943-.14.08-.674 7.254-.316.37-.729.28-.607-.461-.322-.747.322-1.476.389-1.924.315-1.53.286-1.9.17-.632-.012-.042-.14.018-1.434 1.967-2.18 2.945-1.726 1.845-.414.164-.717-.37.067-.662.401-.589 2.388-3.036 1.44-1.882.93-1.086-.006-.158h-.055L4.132 18.56l-1.13.146-.487-.456.061-.746.231-.243 1.908-1.312-.006.006z"></path>
      </svg>
      <div class="menu-item-content">
        <span class="menu-item-title">Open in Claude</span>
        <span class="menu-item-desc">Ask Claude about this page</span>
      </div>
    </button>
  </div>
</div>

<textarea id="raw-markdown" hidden>{markdown}</textarea>

<script>
  import { computePosition, flip, shift, offset, autoUpdate } from '@floating-ui/dom';

  const rawMarkdown = document.getElementById('raw-markdown') as HTMLTextAreaElement;
  
  // Triggers
  const mainCopyBtn = document.getElementById('main-copy-btn');
  const triggerBtn = document.getElementById('dropdown-trigger');
  const dropdown = document.getElementById('dropdown-menu');
  
  // Menu items
  const menuButtons = {
    copy: document.getElementById('menu-copy-btn'),
    view: document.getElementById('menu-view-btn'),
    gpt: document.getElementById('menu-gpt-btn'),
    claude: document.getElementById('menu-claude-btn')
  };

  // Logic
  async function copyToClipboard(button: HTMLElement | null) {
    if (!rawMarkdown || !button) return;
    try {
      await navigator.clipboard.writeText(rawMarkdown.value);
      
      const originalContent = button.innerHTML;
      const originalClasses = button.className;
      
      // Feedback
      button.classList.add('success');
      const span = button.querySelector('span');
      if (span) span.innerText = 'Copied!';
      
      setTimeout(() => {
        button.innerHTML = originalContent;
        button.className = originalClasses;
      }, 2000);
    } catch (err) {
      console.error('Copy failed', err);
    }
  }

  function openInAI(service: 'gpt' | 'claude') {
    // Construct the raw markdown URL
    // Current URL: /type/slug/
    // Raw URL: /raw/type/slug.md
    
    const path = window.location.pathname.replace(/\/$/, '');
    const rawUrl = `${window.location.origin}/raw${path}.md`;
    
    // Prompt for the AI
    const prompt = `Read ${rawUrl} and answer questions about the content.`;
    const encoded = encodeURIComponent(prompt);
    
    let targetUrl = '';
    if (service === 'gpt') {
      targetUrl = `https://chatgpt.com/?q=${encoded}`;
    } else if (service === 'claude') {
      targetUrl = `https://claude.ai/new?q=${encoded}`;
    }
    
    window.open(targetUrl, '_blank');
    hideDropdown();
  }

  // Event Listeners
  if (mainCopyBtn) {
    mainCopyBtn.addEventListener('click', () => copyToClipboard(mainCopyBtn));
  }

  if (menuButtons.copy) {
    menuButtons.copy.addEventListener('click', async () => {
      await copyToClipboard(menuButtons.copy);
      // Wait 1 second (1000ms) before starting the fade out
      setTimeout(hideDropdown, 1000);
    });
  }

  if (menuButtons.view) {
    menuButtons.view.addEventListener('click', () => {
       const win = window.open("", "Markdown View", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=800,height=600");
       if (win) {
         win.document.body.style.backgroundColor = "#0f1219";
         win.document.body.style.color = "#e2e8f0";
         win.document.body.style.fontFamily = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
         win.document.body.style.whiteSpace = "pre-wrap";
         win.document.body.style.padding = "2rem";
         win.document.body.style.fontSize = "14px";
         win.document.body.style.lineHeight = "1.5";
         win.document.body.innerText = rawMarkdown.value;
         win.document.title = "Raw Markdown View";
       }
       hideDropdown();
    });
  }
  
  if (menuButtons.gpt) {
    menuButtons.gpt.addEventListener('click', () => openInAI('gpt'));
  }
  
  if (menuButtons.claude) {
    menuButtons.claude.addEventListener('click', () => openInAI('claude'));
  }

  // Positioning
  let cleanup: (() => void) | undefined;

  function updatePosition() {
    if (!triggerBtn || !dropdown) return;
    computePosition(triggerBtn, dropdown, {
      placement: 'bottom-end',
      middleware: [
        offset(6),
        flip(),
        shift({ padding: 10 })
      ]
    }).then(({ x, y }) => {
      Object.assign(dropdown.style, {
        left: `${x}px`,
        top: `${y}px`,
      });
    });
  }

  function showDropdown() {
    if (!dropdown || !triggerBtn) return;
    dropdown.hidden = false;
    // Slight delay to allow display:block to apply before opacity transition
    requestAnimationFrame(() => {
      dropdown.classList.add('show');
    });
    triggerBtn.setAttribute('aria-expanded', 'true');
    cleanup = autoUpdate(triggerBtn, dropdown, updatePosition);
  }

  function hideDropdown() {
    if (!dropdown || !triggerBtn) return;
    
    // Start fade out
    dropdown.classList.remove('show');
    dropdown.classList.add('hiding');
    
    // Wait for transition to finish before setting hidden
    setTimeout(() => {
      dropdown.hidden = true;
      dropdown.classList.remove('hiding');
      triggerBtn.setAttribute('aria-expanded', 'false');
      if (cleanup) cleanup();
      cleanup = undefined;
    }, 200); // Match CSS transition duration
  }

  if (triggerBtn) {
    triggerBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (dropdown?.hidden) {
        showDropdown();
      } else {
        hideDropdown();
      }
    });
  }

  // Click outside
  document.addEventListener('click', (e) => {
    if (dropdown && !dropdown.hidden && !triggerBtn?.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {
      hideDropdown();
    }
  });
</script>

<style>
  .markdown-control-wrapper {
    position: relative;
    /* Wrapper ensures relative context if needed, but Floating UI uses absolute to body usually, checking styles */
  }

  .split-button {
    display: flex;
    align-items: stretch;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .split-button:hover {
    border-color: rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.08);

  }

  .btn {
    background: transparent;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: color 0.2s, background 0.2s;
  }

  .btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.05); /* Slight highlight on hover specific part */
  }
  
  .btn.success {
    color: #4ade80;
  }

  .btn-left {
    padding-right: 0.5rem;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .btn-right {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }

  .dropdown-menu {
    position: absolute;
    width: max-content;
    min-width: 200px;
    top: 0;
    left: 0;
    background: #1e293b;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    padding: 0.5rem;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    opacity: 0;
    transform: translateY(-5px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    visibility: hidden; /* Use visibility controls instead of display:none to allow transitions */
  }
  
  /* Visible state */
  .dropdown-menu.show {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  
  /* Hiding state (used for fade out) */
  .dropdown-menu.hiding {
    opacity: 0;
    transform: translateY(-5px);
  }

  /* Override the [hidden] attribute to rely on class state for animation flexibility, 
     but keeping it for accessibility/fallback if JS fails or initial state */
  .dropdown-menu[hidden] {
    display: none;
  }

  .menu-item {
    display: flex;
    align-items: flex-start; /* Align to top for multiline */
    gap: 0.75rem;
    width: 100%;
    padding: 0.6rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: #cbd5e1;
    cursor: pointer;
    font-size: 0.875rem;
    text-align: left;
    transition: all 0.2s;
  }

  .menu-item:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
  }
  
  .menu-item.success {
    color: #4ade80;
  }

  .menu-item-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .menu-item-title {
    font-weight: 500;
    line-height: 1.2;
  }

  .menu-item-desc {
    font-size: 0.75rem;
    color: #94a3b8;
    line-height: 1.3;
  }

  .menu-item:hover .menu-item-desc {
    color: #cbd5e1;
  }

  .menu-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 0.25rem 0;
  }

  .icon {
    flex-shrink: 0;
    margin-top: 0.1rem; /* Align icon with first line of text */
  }
  
  textarea[hidden] {
    display: none;
  }
</style>
